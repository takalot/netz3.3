<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zmanim Pro - With Midnight</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: Tahoma, sans-serif; font-weight: bold; background-color: black; color: white; overflow: hidden; }
        .hebrew-font { font-family: "Arial Hebrew", "David", "Miriam", Tahoma, sans-serif; direction: rtl; }
        ::-webkit-scrollbar { width: 0; }
        
        .zman-card { transition: all 0.4s ease; min-width: 140px; border: 1px solid #1f2937; position: relative; }
        .passed-zman { border: 1px solid #facc15 !important; opacity: 0.7; }
        
        .next-zman-highlight { 
            border: 3px solid #facc15 !important; 
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.5);
            transform: scale(1.05);
            z-index: 20;
            background: rgba(250, 204, 21, 0.05);
        }

        .countdown-active {
            text-shadow: 0 0 30px rgba(239, 68, 68, 0.4);
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% { opacity: 1; }
            50% { opacity: 0.85; }
            100% { opacity: 1; }
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>

<body class="h-screen flex flex-col">

<header id="header" class="hidden bg-gray-900 border-b border-gray-800 p-3 shadow-2xl">
    <div class="flex items-center justify-center flex-wrap gap-3 md:gap-5 text-lg md:text-xl">
        <div class="flex items-center gap-2">
            <span id="system-time" class="text-yellow-400 text-2xl font-mono">--:--:--</span>
        </div>
        <span class="text-gray-700">|</span>
        <div id="day-of-week" class="text-blue-200 font-bold">--</div>
        <span class="text-gray-700">|</span>
        <div class="hebrew-font text-blue-400" id="hebrew-date">--</div>
        <span class="text-gray-700">|</span>
        <div class="text-yellow-400 font-normal" id="gregorian-date">--</div>
        <span class="text-gray-700">|</span>
        <div class="flex items-center gap-2">
            <span class="text-gray-500">דף יומי:</span>
            <span class="hebrew-font text-green-500" id="daf-yomi">--</span>
        </div>
    </div>
</header>

<main class="flex-grow flex flex-col justify-center items-center px-4">
    <div id="loading-state" class="text-2xl animate-pulse text-blue-500">טוען נתונים...</div>
    <div id="countdown-zone" class="hidden text-center w-full">
        <div id="zman-name" class="text-2xl md:text-3xl text-gray-500 mb-1 uppercase tracking-widest">--</div>
        <h1 id="zman-target-time" class="text-4xl md:text-6xl text-yellow-500 font-extrabold mb-4 hebrew-font drop-shadow-2xl">--</h1>
        <div class="timer-container">
            <div id="mode-indicator" class="text-xl md:text-2xl text-white opacity-90 font-bold mb-0 leading-none">מצב שעון נוכחי</div>
            <div id="main-timer" class="text-[22vw] md:text-[18vw] leading-none font-bold tabular-nums tracking-tighter mt-1">00:00:00</div>
        </div>
    </div>
</main>

<footer id="zmanim-grid" class="hidden bg-gray-950 border-t border-gray-800 p-4 pb-8">
    <div id="zmanim-list" class="flex justify-center items-center gap-3 overflow-x-auto no-scrollbar"></div>
</footer>

<script>
const CONFIG = {
    LAT : 31.7946859557658,
    LNG : 35.21589133333333,
    TIMEZONE: 'Asia/Jerusalem',
    COUNTDOWN_LIMIT_MS: 30 * 60 * 1000,
    GEONAME_ID: 295620
};

let state = { zmanim: [], halachicMidnight: null, nextDayFirstZman: null };

const Utils = {
    getElement(id) { return document.getElementById(id); },
    formatTime(date, sec = true) {
        return date.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit', second: sec ? '2-digit' : undefined, hour12: false });
    }
};

const UI = {
    async update() {
        const now = new Date();
        if (state.halachicMidnight && now >= state.halachicMidnight) { await App.loadDay(new Date()); return; }

        const activeZman = [...state.zmanim].reverse().find(i => i.time <= now);
        let nextZman = state.zmanim.find(i => i.time > now);
        let nextZmanIndex = state.zmanim.findIndex(i => i.time > now);

        if (!nextZman && state.nextDayFirstZman) {
            nextZman = state.nextDayFirstZman;
            nextZmanIndex = 0; 
        }

        Utils.getElement('system-time').textContent = Utils.formatTime(now);
        Utils.getElement('zman-name').textContent = activeZman ? activeZman.name + " עבר" : "הכנה ליום חדש";
        
        document.querySelectorAll('.zman-card').forEach((card, i) => {
            card.classList.remove('passed-zman', 'next-zman-highlight');
            if (i === nextZmanIndex) {
                card.classList.add('next-zman-highlight');
            } else if (state.zmanim[i].time <= now) {
                card.classList.add('passed-zman');
            }
        });

        const timer = Utils.getElement('main-timer');
        const mode = Utils.getElement('mode-indicator');
        const target = Utils.getElement('zman-target-time');

        if (nextZman) {
            const diff = nextZman.time - now;
            target.textContent = `הזמן הבא: ${nextZman.name} ב-${Utils.formatTime(nextZman.time, false)}`;

            if (diff > CONFIG.COUNTDOWN_LIMIT_MS) {
                timer.textContent = Utils.formatTime(now);
                timer.className = "text-[22vw] md:text-[18vw] text-white font-bold tracking-tighter leading-none";
                mode.textContent = "מצב שעון נוכחי";
            } else {
                const h = Math.floor(diff / 3600000), m = Math.floor((diff % 3600000) / 60000), s = Math.floor((diff % 60000) / 1000);
                timer.textContent = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                let color = 'text-yellow-500';
                if (diff <= 300000) color = 'text-red-500 countdown-active'; 
                else if (diff <= 900000) color = 'text-orange-500';
                timer.className = `text-[22vw] md:text-[18vw] font-bold ${color} tracking-tighter leading-none`;
                mode.textContent = `ספירה לאחור ל${nextZman.name}`;
            }
        }
    }
};

const API = {
    async fetchDayData(date) {
        const dateStr = date.toISOString().split('T')[0];
        const sunUrl = `https://api.sunrisesunset.io/json?lat=${CONFIG.LAT}&lng=${CONFIG.LNG}&date=${dateStr}&timezone=${CONFIG.TIMEZONE}`;
        const hebUrl = `https://www.hebcal.com/hebcal?cfg=json&start=${dateStr}&end=${dateStr}&geo=geoname&geonameid=${CONFIG.GEONAME_ID}&d=on&s=on&F=on&h=on`;
        
        try {
            const [sunRes, hebRes] = await Promise.all([fetch(sunUrl), fetch(hebUrl)]);
            const sunData = await sunRes.json();
            const hebData = await hebRes.json();
            const r = sunData.results;

            const parse = (timeStr, base) => {
                const [time, period] = timeStr.split(' ');
                let [h, m, s] = time.split(':').map(Number);
                if (period === 'PM' && h !== 12) h += 12;
                if (period === 'AM' && h === 12) h = 0;
                const d = new Date(base); d.setHours(h, m, s || 0, 0); return d;
            };

            const sunrise = parse(r.sunrise, date);
            const sunset = parse(r.sunset, date);
            const noon = parse(r.solar_noon, date);
            const dayLen = sunset - sunrise;
            const midnight = new Date(noon.getTime() + 12 * 60 * 60 * 1000);

            return {
                zmanim: [
                    { name: "עלות השחר", time: new Date(sunrise - 72 * 60000) },
                    { name: "נץ החמה", time: sunrise },
                    { name: "סוף זמן שמע", time: new Date(sunrise.getTime() + (dayLen / 4)) },
                    { name: "חצות היום", time: noon },
                    { name: "מנחה גדולה", time: new Date(noon.getTime() + 30 * 60000) },
                    { name: "פלג המנחה", time: new Date(sunset.getTime() - (dayLen * 1.25 / 12)) },
                    { name: "שקיעה", time: sunset },
                    { name: "צאת הכוכבים", time: new Date(sunset.getTime() + 20 * 60000) },
                    { name: "חצות לילה", time: midnight } // הוספת חצות לילה לרשימה
                ].sort((a,b) => a.time - b.time),
                halachicMidnight: midnight,
                calendar: hebData.items
            };
        } catch (e) { return null; }
    }
};

const App = {
    async loadDay(date) {
        let data = await API.fetchDayData(date);
        const now = new Date();
        if (data && now < data.halachicMidnight && now.getHours() < 12) {
            const yesterday = new Date(date); yesterday.setDate(yesterday.getDate() - 1);
            data = await API.fetchDayData(yesterday);
            date = yesterday;
        }
        
        const tomorrow = new Date(date); tomorrow.setDate(tomorrow.getDate() + 1);
        const nextData = await API.fetchDayData(tomorrow);
        if (nextData) state.nextDayFirstZman = nextData.zmanim[0];

        this.applyData(data, date);
    },
    applyData(data, date) {
        state.zmanim = data.zmanim; state.halachicMidnight = data.halachicMidnight;
        Utils.getElement('day-of-week').textContent = date.toLocaleDateString('he-IL', { weekday: 'long' });
        Utils.getElement('hebrew-date').textContent = data.calendar.find(i => i.hebrew)?.hebrew || '';
        Utils.getElement('gregorian-date').textContent = date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
        Utils.getElement('daf-yomi').textContent = data.calendar.find(i => i.category === 'dafyomi')?.hebrew || '';
        
        const list = Utils.getElement('zmanim-list'); list.innerHTML = '';
        state.zmanim.forEach(z => {
            const d = document.createElement('div');
            d.className = `zman-card bg-gray-900 p-3 rounded-lg text-center`;
            d.innerHTML = `<div class="text-gray-500 text-[10px] md:text-xs mb-1 uppercase tracking-wider">${z.name}</div><div class="text-white text-lg md:text-xl font-bold font-mono">${Utils.formatTime(z.time, true)}</div>`;
            list.appendChild(d);
        });
        Utils.getElement('loading-state').style.display = 'none';
        Utils.getElement('countdown-zone').classList.remove('hidden');
        Utils.getElement('header').classList.remove('hidden');
        Utils.getElement('zmanim-grid').classList.remove('hidden');
    },
    async init() { await this.loadDay(new Date()); setInterval(() => UI.update(), 1000); }
};
document.addEventListener('DOMContentLoaded', () => App.init());
</script>
</body>
</html>
